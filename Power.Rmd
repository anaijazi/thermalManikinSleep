---
title: "Appendix: Power"
author: "Arfa Aijazi"
date: "2/26/2022"
output: github_document
---
Load libraries  
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(zoo)
```

Load power data for all PCS 
```{r echo=TRUE, message=FALSE, warning=FALSE}
data_dir <- "data/Power"

colNames_hobo <- c("PCS", "Baseline", "Time", "Power", "Cycle")
data_files <- list.files(path = data_dir, pattern = "*.csv", full.names = TRUE)

data_all <- lapply(data_files, read_csv, col_types = cols())

PCS_data <- data_all %>%
  reduce(full_join) %>%
  group_by(PCS, Baseline) %>%
  mutate(Time = mdy_hms(Time)) %>%
  drop_na(Power)
```
```{r include=FALSE}
theme_custom = function() {
  theme_minimal() %+replace%
    theme(legend.position = "top") +
    theme(panel.grid = element_blank())
}
plot_colors <- c("#4477AA", "#CCBB44", "#228833", "#EE6677", "#AA3377", "#66CCEE")
```

## Electric mattress pad
Plot power consumption of electric mattress pad over time  
```{r echo=FALSE}
ElectricMP_data <- PCS_data %>%
  filter(str_detect(PCS, "ElectricMP")) %>%
  filter(is.na(Cycle) == FALSE) %>%
  group_by(PCS, Baseline) %>%
  mutate(Timestep = 1:n()*5/60)

ggplot(ElectricMP_data, aes(x = Timestep, y = Power)) +
  geom_line(aes(colour = PCS, linetype = Baseline)) +
  scale_color_manual(values = plot_colors) +
  scale_x_continuous(limits = c(0,10)) +
  theme_custom() +
  xlab("Time (minutes)") +
  ylab("Power (W)")
```
Average power consumption in each cycle  
```{r message=FALSE, warning=FALSE}
ElectricMP_avg <- ElectricMP_data %>%
  group_by(PCS, Baseline, Cycle) %>%
  summarize(Mean.Power = mean(Power))

ElectricMP_avg
```
Plot average power consumption by mattress pad setting and manikin clothing/bedding. Use of heavy clothing and bedding reduces electric mattress pad power consumption by approximately 3 W.  
```{r echo=FALSE}
ggplot(ElectricMP_avg, aes(x = PCS, y = Mean.Power)) +
  geom_boxplot(aes(fill = Baseline)) +
  scale_fill_manual(values = plot_colors) +
  theme_custom() 
```


```{r message=FALSE, warning=FALSE}
ElectricMP_avg <- ElectricMP_data %>%
  group_by(PCS, Baseline) %>%
  summarize(Mean.Power = mean(Power))
ElectricMP_avg
```

## Heated blanket
```{r}
HeatedBlanket_data <- PCS_data %>%
  filter(str_detect(PCS, "HeatedBlanket")) %>%
  select(-Cycle) %>%
  group_by(Baseline) %>%
  mutate(Power_60min = rollmean(Power, k = 720, fill = NA)) %>%
  ungroup()
HeatedBlanket_data
```
```{r}
ggplot(HeatedBlanket_data, aes(x = Time, y = Power_60min)) + 
  geom_line(aes(colour = Baseline, linetype = Baseline)) +
  scale_colour_manual(values = plot_colors) +
  theme_custom() 
```

